<h2>Registrar venta</h2>

<form [formGroup]="formBusqueda" (ngSubmit)="buscarYAgregar()">
  <div class="search-section">
    <input 
      id="codigoBarras" 
      type="text" 
      formControlName="codigoBarras"
      placeholder="Código de barras"
      required
      #codigoBarrasInput
    />
    <button type="button" class="btn-search" (click)="abrirModalBusqueda()">
      Buscar
    </button>
  </div>
</form>

<div class="modal" *ngIf="mostrarModalBusqueda">
  <div class="modal-content">
    <div class="modal-header">
      <span>Buscar producto</span>
      <button (click)="cerrarModalBusqueda()">&times;</button>
    </div>
    <input type="text" [(ngModel)]="filtroNombre" (input)="filtrarProductosPorNombre()" placeholder="Nombre del producto" />
    <div class="products-list">
      <div class="list-header">
        <span>Nombre</span>
        <span>Precio</span>
        <span>Stock</span>
      </div>
      <div *ngFor="let prod of productosFiltrados" class="product-item" (click)="agregarProductoDesdeModal(prod)">
        <span class="name">{{ prod.nombre }}</span>
        <span class="price">{{ prod.precioVenta | currency:'$' }}</span>
        <span class="stock" [class.low]="prod.stock < prod.stockMinimo">{{ prod.stock }}</span>
      </div>
      <div *ngIf="productosFiltrados.length === 0" class="no-products">
        No se encontraron productos
      </div>
    </div>
  </div>
</div>

<div class="product-preview" *ngIf="productoEncontrado">
  <span class="name">{{ productoEncontrado.nombre }}</span>
  <span class="price">{{ productoEncontrado.precioVenta | currency:'$' }}</span>
  <span class="stock" [class.low]="productoEncontrado.stock < productoEncontrado.stockMinimo">
    Stock: {{ productoEncontrado.stock }}
  </span>
</div>

<div class="selected-products" *ngIf="seleccionados.length > 0">
  <div class="table-header">
    <span>Producto</span>
    <span>Cantidad</span>
    <span>Subtotal</span>
    <span></span>
  </div>
  <div *ngFor="let item of seleccionados; let i = index" class="product-row">
    <div class="product-info">
      <span class="name">{{ item.producto.nombre }}</span>
      <span class="price">{{ item.producto.precioVenta | currency:'$' }}</span>
    </div>
    <div class="quantity-section">
      <span class="warning" *ngIf="item.cantidad > item.producto.stock">Stock insuficiente</span>
      <input 
        type="number" 
        [value]="item.cantidad"
        (change)="actualizarCantidad(i, $event)"
        min="0.001"
        step="any"
        [max]="item.producto.stock"
      />
    </div>
    <span class="subtotal">{{ item.subtotal | currency:'$' }}</span>
    <button class="btn-remove" (click)="quitarItem(i)">×</button>
  </div>
</div>

<div class="sale-summary" *ngIf="seleccionados.length > 0">
  <div class="total-info">
    <span class="total">{{ total | currency:'$' }}</span>
    <span class="items">{{ seleccionados.length }} items</span>
  </div>
  <button class="btn-confirm" (click)="abrirModalConfirmacion()" [disabled]="!puedeConfirmar">
    Confirmar venta
  </button>
</div>

<div class="modal" *ngIf="mostrarModalConfirmacion">
  <div class="modal-content confirmation">
    <div class="modal-header">
      <span>Confirmar Venta</span>
    </div>
    <div class="confirmation-content">
      <p>¿Estás seguro de que quieres realizar esta venta?</p>
      <div class="sale-summary-confirm">
        <div class="summary-item">
          <span class="label">Total:</span>
          <span class="value">{{ total | currency:'$' }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Productos:</span>
          <span class="value">{{ seleccionados.length }} items</span>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="cerrarModalConfirmacion()">
        Cancelar
      </button>
      <button class="btn-confirm-final" (click)="confirmarVentaFinal()">
        Confirmar
      </button>
    </div>
  </div>
</div>

<div class="toast" *ngIf="mostrarToast" [class.error]="toastMensaje.includes('Error')">
  {{ toastMensaje }}
</div>