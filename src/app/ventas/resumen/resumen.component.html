<h2>Resumen de ventas</h2>

<div *ngIf="cargando" class="loading">
  Cargando ventas...
</div>

<div *ngIf="error" class="error">
  {{ error }}
</div>

<div *ngIf="!cargando" class="content">
  <div class="controls">
    <select [(ngModel)]="modoAgrupacion" (change)="calcularTotales()">
      <option value="dia">Por día</option>
      <option value="semana">Por semana</option>
      <option value="mes">Por mes</option>
    </select>

    <div class="filters" *ngIf="ventas.length > 0">
      <input type="date" [(ngModel)]="fechaDesde" (change)="aplicarFiltros()" placeholder="Desde" />
      <input type="date" [(ngModel)]="fechaHasta" (change)="aplicarFiltros()" placeholder="Hasta" />
      <input type="text" [(ngModel)]="busquedaProducto" (input)="aplicarFiltros()" placeholder="Buscar producto" />
    </div>
  </div>

  <div *ngIf="totalesAgrupados.length > 0" class="totals-summary">
    <h3>Totales por {{ modoAgrupacion }}</h3>
    <div class="totals-grid">
      <div *ngFor="let item of totalesAgrupados" class="total-item">
        <span class="period">{{ item.clave }}</span>
        <span class="amount">{{ item.total | currency:'$' }}</span>
      </div>
    </div>
    <button class="btn-export" (click)="exportarResumen()">
      Exportar Excel
    </button>
  </div>

  <div class="sales-list" *ngIf="ventas.length > 0">
    <div class="table-header">
      <span>ID</span>
      <span>Fecha</span>
      <span>Total</span>
      <span>Items</span>
      <span></span>
    </div>
    <div *ngFor="let v of ventasPaginadas; let i = index" class="sale-item">
      <div class="sale-header" (click)="toggleDetalle(i)">
        <span class="id">#{{ v.id }}</span>
        <span class="date">{{ v.fecha | date:'dd/MM/yyyy HH:mm' }}</span>
        <span class="total">{{ v.total | currency:'$' }}</span>
        <span class="items">{{ v.detalles?.length || 0 }} items</span>
        <span class="toggle">{{ expandedIndex === i ? '−' : '+' }}</span>
      </div>
      
      <div *ngIf="expandedIndex === i" class="sale-details">
        <div class="detail-header">
          <span>Producto</span>
          <span>Cantidad</span>
          <span>Precio Unit.</span>
          <span>Subtotal</span>
        </div>
        <div *ngFor="let d of v.detalles" class="detail-item">
          <span class="product">{{ d.producto?.nombre || 'Producto no encontrado' }}</span>
          <span class="quantity">{{ d.cantidad }}</span>
          <span class="price">{{ d.precioUnitario | currency:'$' }}</span>
          <span class="subtotal">{{ d.precioUnitario * d.cantidad | currency:'$' }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="pagination" *ngIf="totalPaginas > 1">
    <button (click)="paginaActual = paginaActual - 1" [disabled]="paginaActual === 1">
      ← Anterior
    </button>
    <span>{{ paginaActual }} de {{ totalPaginas }}</span>
    <button (click)="paginaActual = paginaActual + 1" [disabled]="paginaActual === totalPaginas">
      Siguiente →
    </button>
  </div>

  <div *ngIf="ventas.length === 0" class="no-data">
    <p>No hay ventas registradas</p>
  </div>
</div>