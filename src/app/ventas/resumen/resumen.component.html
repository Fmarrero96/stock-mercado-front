<h2>Resumen de ventas</h2>

<div *ngIf="cargando" class="cargando">
    Cargando ventas...
</div>

<p *ngIf="error" class="error">{{ error }}</p>

<div *ngIf="!cargando">

    <div class="agrupador">
        <label>Ver totales por:</label>
        <select [(ngModel)]="modoAgrupacion" (change)="calcularTotales()">
          <option value="dia">D√≠a</option>
          <option value="semana">Semana</option>
          <option value="mes">Mes</option>
        </select>
      </div>
    
      <div *ngIf="totalesAgrupados.length > 0" class="resumen-totales">
        <h3>Totales por {{ modoAgrupacion }}</h3>
        <ul>
          <li *ngFor="let item of totalesAgrupados">
            <strong>{{ item.clave }}:</strong> {{ item.total | currency:'ARS' }}
          </li>
        </ul>
        <button (click)="exportarResumen()" class="btn-exportar">üìÅ Exportar a Excel</button>
      </div>

    <!-- Filtros -->
    <div class="filtros" *ngIf="!cargando && ventas.length > 0">
        <label>Desde:</label>
        <input type="date" [(ngModel)]="fechaDesde" (change)="aplicarFiltros()" />

        <label>Hasta:</label>
        <input type="date" [(ngModel)]="fechaHasta" (change)="aplicarFiltros()" />

        <label>Buscar producto:</label>
        <input type="text" [(ngModel)]="busquedaProducto" (input)="aplicarFiltros()" placeholder="Ej: Yerba" />
    </div>
    <table *ngIf="ventas.length > 0; else sinVentas">
        <thead>
            <tr>
                <th>ID</th>
                <th>Fecha</th>
                <th>Total</th>
                <th>Cantidad √≠tems</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <ng-container *ngFor="let v of ventasPaginadas; let i = index">

                <!-- Fila principal -->
                <tr>
                    <td>{{ v.id }}</td>
                    <td>{{ v.fecha | date:'dd/MM/yyyy HH:mm' }}</td>
                    <td>{{ v.total | currency:'ARS' }}</td>
                    <td>{{ v.detalles?.length || 0 }}</td>
                    <td>
                        <button (click)="toggleDetalle(i)">
                            {{ expandedIndex === i ? 'üîΩ Ocultar' : 'üîº Ver detalle' }}
                        </button>
                    </td>
                </tr>

                <!-- Detalle expandido -->
                <tr *ngIf="expandedIndex === i">
                    <td colspan="5">
                        <table class="detalle">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let d of v.detalles">
                                    <td>{{ d.producto?.nombre || 'Producto no encontrado' }}</td>
                                    <td>{{ d.cantidad }}</td>
                                    <td>{{ d.precioUnitario | currency:'ARS' }}</td>
                                    <td>{{ d.precioUnitario * d.cantidad | currency:'ARS' }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
            </ng-container>
        </tbody>
    </table>

    <div class="paginacion" *ngIf="totalPaginas > 1">
        <button (click)="paginaActual = paginaActual - 1" [disabled]="paginaActual === 1">‚¨ÖÔ∏è Anterior</button>
        <span>P√°gina {{ paginaActual }} de {{ totalPaginas }}</span>
        <button (click)="paginaActual = paginaActual + 1" [disabled]="paginaActual === totalPaginas">Siguiente ‚û°Ô∏è</button>
    </div>

    <ng-template #sinVentas>
        <p class="sin-datos">No hay ventas registradas.</p>
    </ng-template>
</div>

<button (click)="cargarVentas()" [disabled]="cargando">
    üîÑ Recargar
</button>