<div class="header">
  <h2>Productos</h2>
  <div class="actions">
    <button class="btn-add" (click)="abrirModalAgregarStock()">
      Agregar Stock
    </button>
    <button class="btn-add" (click)="abrirModalCrear()">
      Nuevo
    </button>
  </div>
</div>

<div class="search">
  <input 
    #searchInput
    type="text" 
    [(ngModel)]="terminoBusqueda" 
    (ngModelChange)="filtrarProductos()"
    placeholder="Buscar productos..."
    id="searchInput"
  >
</div>

<div class="products-table" *ngIf="productos.length > 0">
  <div class="table-header">
    <span>Código</span>
    <span>Nombre</span>
    <span>Precio</span>
    <span>Stock</span>
    <span>Categoría</span>
    <span></span>
  </div>
  <div *ngFor="let producto of productosFiltrados" class="product-row">
    <span class="code">{{producto.codigoBarra}}</span>
    <span class="name">{{producto.nombre}}</span>
    <span class="price">{{producto.precioVenta | currency:'$'}}</span>
    <span class="stock" [class.low]="producto.stock < 10">{{producto.stock}}</span>
    <span class="category">{{ getNombreCategoria(producto.categoriaId) }}</span>
    <div class="actions">
      <button class="btn-edit" (click)="editarProducto(producto)">✏️</button>
      <button class="btn-delete" (click)="abrirConfirmacionEliminar(producto)">×</button>
    </div>
  </div>
</div>

<div *ngIf="productos.length === 0" class="no-data">
  <p>No hay productos registrados</p>
</div>

<div class="modal" *ngIf="mostrarModal">
  <div class="modal-content product-form">
    <div class="modal-header">
      <span>{{modoEdicion ? 'Editar' : 'Nuevo'}} Producto</span>
      <button (click)="cerrarModal()">&times;</button>
    </div>

    <div class="modal-body">
      <form [formGroup]="productoForm">
        <div class="form-grid">
          <div class="form-field">
            <label for="codigoBarra">Código</label>
            <input 
              id="codigoBarra" 
              type="text" 
              formControlName="codigoBarra"
              [class.error]="productoForm.get('codigoBarra')?.invalid && productoForm.get('codigoBarra')?.touched"
            >
            <span class="error" *ngIf="productoForm.get('codigoBarra')?.invalid && productoForm.get('codigoBarra')?.touched">
              Requerido
            </span>
          </div>

          <div class="form-field">
            <label for="nombre">Nombre</label>
            <input 
              id="nombre" 
              type="text" 
              formControlName="nombre"
              [class.error]="productoForm.get('nombre')?.invalid && productoForm.get('nombre')?.touched"
            >
            <span class="error" *ngIf="productoForm.get('nombre')?.invalid && productoForm.get('nombre')?.touched">
              Requerido
            </span>
          </div>

          <div class="form-field full-width">
            <label for="descripcion">Descripción</label>
            <input 
              id="descripcion" 
              type="text"
              formControlName="descripcion"
              placeholder="Descripción del producto"
            >
          </div>

          <div class="form-field full-width">
            <label for="categoria">Categoría</label>
            <select 
              id="categoria"
              formControlName="categoriaId"
              [class.error]="productoForm.get('categoriaId')?.invalid && productoForm.get('categoriaId')?.touched"
            >
              <option [ngValue]="null" disabled>Seleccione categoría</option>
              <option *ngFor="let categoria of categoriasDisponibles" [ngValue]="categoria.id">
                {{ categoria.nombre }}
              </option>
            </select>
            <span class="error" *ngIf="productoForm.get('categoriaId')?.invalid && productoForm.get('categoriaId')?.touched">
              Requerido
            </span>
          </div>
        </div>

        <div class="section">Precios</div>
        <div class="form-grid">
          <div class="form-field">
            <label for="precioCompra">Compra</label>
            <input 
              id="precioCompra" 
              type="number" 
              formControlName="precioCompra"
              [class.error]="productoForm.get('precioCompra')?.invalid && productoForm.get('precioCompra')?.touched"
            >
            <span class="error" *ngIf="productoForm.get('precioCompra')?.invalid && productoForm.get('precioCompra')?.touched">
              Requerido
            </span>
          </div>
          
          <div class="form-field">
            <label for="precioVenta">Venta</label>
            <input 
              id="precioVenta" 
              type="number" 
              formControlName="precioVenta"
              [class.error]="productoForm.get('precioVenta')?.invalid && productoForm.get('precioVenta')?.touched"
            >
            <span class="error" *ngIf="productoForm.get('precioVenta')?.invalid && productoForm.get('precioVenta')?.touched">
              Requerido
            </span>
          </div>

          <div class="form-field">
            <label>Ganancia (%)</label>
            <input 
              formControlName="gananciaPorcentaje" 
              type="number" 
              placeholder="0.00"
              step="0.01"
            />
            <span class="error" *ngIf="productoForm.get('gananciaPorcentaje')?.errors?.['min'] && productoForm.get('gananciaPorcentaje')?.touched">
              No negativo
            </span>
          </div>
        </div>

        <div class="section">Stock</div>
        <div class="form-grid">
          <div class="form-field">
            <label for="stock">Actual</label>
            <input 
              id="stock" 
              type="number" 
              formControlName="stock"
              [class.error]="productoForm.get('stock')?.invalid && productoForm.get('stock')?.touched"
            >
            <span class="error" *ngIf="productoForm.get('stock')?.invalid && productoForm.get('stock')?.touched">
              Requerido
            </span>
          </div>
          
          <div class="form-field">
            <label for="stockMinimo">Mínimo</label>
            <input 
              id="stockMinimo" 
              type="number" 
              formControlName="stockMinimo"
              [class.error]="productoForm.get('stockMinimo')?.invalid && productoForm.get('stockMinimo')?.touched"
            >
            <span class="error" *ngIf="productoForm.get('stockMinimo')?.invalid && productoForm.get('stockMinimo')?.touched">
              Requerido
            </span>
          </div>
        </div>
      </form>
    </div>

    <div class="modal-actions">
      <button class="btn-cancel" (click)="cerrarModal()">Cancelar</button>
      <button 
        class="btn-save" 
        (click)="modoEdicion ? abrirConfirmacionGuardarEdicion() : guardarProducto()"
        [disabled]="guardando"
      >
        {{guardando ? 'Guardando...' : 'Guardar'}}
      </button>
    </div>
  </div>
</div>

<!-- Modal de Confirmación - Solo para Eliminar -->

<div class="modal" *ngIf="mostrarConfirmacionEliminar">
  <div class="modal-content confirmation">
    <div class="modal-header">
      <span>Eliminar Producto</span>
    </div>
    <div class="confirmation-content">
      <p>¿Estás seguro de que quieres eliminar este producto?</p>
      <div class="product-info" *ngIf="productoSeleccionado">
        <div class="info-item">
          <span class="label">Nombre:</span>
          <span class="value">{{ productoSeleccionado.nombre }}</span>
        </div>
        <div class="info-item">
          <span class="label">Stock actual:</span>
          <span class="value">{{ productoSeleccionado.stock }} unidades</span>
        </div>
      </div>
      <div class="warning">
        Esta acción no se puede deshacer.
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="cerrarConfirmacionEliminar()">
        Cancelar
      </button>
      <button class="btn-confirm-final danger" (click)="confirmarEliminar()">
        Eliminar
      </button>
    </div>
  </div>
</div>

<div class="modal" *ngIf="mostrarConfirmacionGuardarEdicion">
  <div class="modal-content confirmation">
    <div class="modal-header">
      <span>Guardar Cambios</span>
    </div>
    <div class="confirmation-content">
      <p>¿Estás seguro de que quieres guardar los cambios realizados al producto?</p>
      <div class="product-info" *ngIf="productoEditando">
        <div class="info-item">
          <span class="label">Producto:</span>
          <span class="value">{{ productoEditando.nombre }}</span>
        </div>
        <div class="info-item">
          <span class="label">Código:</span>
          <span class="value">{{ productoEditando.codigoBarra }}</span>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="cerrarConfirmacionGuardarEdicion()">
        Cancelar
      </button>
      <button class="btn-confirm-final" (click)="confirmarGuardarEdicion()">
        Guardar Cambios
      </button>
    </div>
  </div>
</div>

<div class="error" *ngIf="error">
  {{error}}
</div>

<div class="modal" *ngIf="mostrarModalStock">
  <div class="modal-content stock-form">
    <div class="modal-header">
      <span>Agregar Stock</span>
      <button (click)="cerrarModalStock()">&times;</button>
    </div>
    <div class="modal-body">
      <form [formGroup]="stockForm">
        <div class="form-field">
          <label for="codigoBarraStock">Código de barras</label>
          <input 
            id="codigoBarraStock" 
            type="text" 
            formControlName="codigoBarra"
            (blur)="buscarProductoPorCodigo()"
            placeholder="Código de barras"
            [class.error]="stockForm.get('codigoBarra')?.invalid && stockForm.get('codigoBarra')?.touched"
          >
          <span class="error" *ngIf="stockForm.get('codigoBarra')?.invalid && stockForm.get('codigoBarra')?.touched">
            Requerido
          </span>
        </div>

        <div class="product-found" *ngIf="productoEncontrado">
          <div class="product-info">
            <span class="name">{{ productoEncontrado.nombre }}</span>
            <span class="stock">Stock: {{ productoEncontrado.stock }}</span>
          </div>
        </div>

        <div class="form-field">
          <label for="cantidadAgregar">Cantidad a agregar</label>
          <input 
            id="cantidadAgregar" 
            type="number" 
            formControlName="cantidadAgregar"
            [disabled]="!productoEncontrado"
            placeholder="Cantidad"
            [class.error]="stockForm.get('cantidadAgregar')?.invalid && stockForm.get('cantidadAgregar')?.touched"
          >
          <span class="error" *ngIf="stockForm.get('cantidadAgregar')?.invalid && stockForm.get('cantidadAgregar')?.touched">
            Requerido
          </span>
        </div>
      </form>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="cerrarModalStock()">Cancelar</button>
      <button 
        class="btn-save" 
        (click)="guardarStock()"
        [disabled]="stockForm.invalid || !productoEncontrado || stockForm.get('cantidadAgregar')?.value <= 0"
      >Guardar</button>
    </div>
  </div>
</div>
  